<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>test</title>
</head>

<body>
    <div id="app"></div>
    <script>
        var xhr = null;
        if (window.XMLHttpRequest) {
            xhr = new XMLHttpRequest();
        } else {
            xhr = ActiveXObject('Microsoft.XMLHTTP');
        }
        // console.log(xhr.readyState);
        // open方法，的第三个参数为true或者不传，为异步模式，如果传入false，为同步模式
        xhr.open('get', 'https://developer.duyiedu.com/edu/testAjaxCrossOrigin', true);
        // console.log(xhr.readyState);
        xhr.onreadystatechange = function () {
            // readyState == 4表示请求完成，已经接收到数据
            if (xhr.readyState == 4 && xhr.status == 200) {
                var data = JSON.parse(xhr.responseText);
                console.log(data);
                document.getElementById('app').innerHTML = data.msg;
            }
        }
        xhr.send();
        console.log('=====')
        console.log('+++++')


        var $ = {
            ajax: function (options) {
                var url = options.url;
                var type = options.type;
                var dataType = options.dataType;
                // 判断是否同源
                // 获取目标URL的域
                var targetProtocol = ''; // 目标接口的协议
                var targetHost = ''; // 目标接口的host
                if (url.indexOf('http://') == 0 || url.indexOf('https://') == 0) {
                    var targetUrl = new URL(url);
                    targetProtocol = targetUrl.protocol;
                    targetHost = targetUrl.host;
                } else {
                    targetProtocol = location.protocol;
                    targetHost = location.host;
                }
                if (dataType == 'jsonp') {
                    // 看是否同源
                    // 同源  通过ajax直接请求数据
                    if (location.protocol == targetProtocol && location.host == targetHost) {
                        var xhr = null;
                        if (window.XMLHttpRequest) {
                            xhr = new XMLHttpRequest();
                        } else {
                            xhr = ActiveXObject('Microsoft.XMLHTTP');
                        }
                        // console.log(xhr.readyState);
                        // open方法，的第三个参数为true或者不传，为异步模式，如果传入false，为同步模式
                        xhr.open(type, url, true);
                        // console.log(xhr.readyState);
                        xhr.onreadystatechange = function () {
                            // readyState == 4表示请求完成，已经接收到数据
                            if (xhr.readyState == 4 && xhr.status == 200) {
                                var data = JSON.parse(xhr.responseText);
                                console.log(data);
                                document.getElementById('app').innerHTML = data.msg;
                            }
                        }
                        xhr.send();
                    }
                    // 不同源
                    else {
                        var callback = 'cb' + Math.floor(Math.random() * 1000000);
                        window[callback] = options.success;
                        // 生成script标签
                        var script = document.createElement('script');
                        if (url.indexOf('?') > 0) {
                            script.src = url + '&callback=' + callback;
                        } else {
                            script.src = url + '?callback=' + callback;
                        }
                        script.id = callback;
                        document.head.appendChild(script);
                    }
                }
            }
        }

        $.ajax({
            url: 'https://developer.duyiedu.com/edu/testJsonp',
            type: 'get',
            dataType: 'jsonp',
            success: function (data) {
                console.log(data);
            }
        })
    </script>
</body>

</html>